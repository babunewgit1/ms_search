<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.14.3/dist/algoliasearch.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>
  </head>
  <body>
    <div class="onewaybj">
      <div class="algolio_wrapper change_grid algwrapper">
        <form class="algolio_length" autocomplete="off">
          <div class="emform onwaygrid bjf_grid">
            <div class="eminputblock">
              <label class="bjlabel">Departure Airport</label>
              <div class="eminput_field">
                <input
                  class="algolio_input onewayform plan_filter_form_input"
                  type="text"
                />
                <div class="cross_input_icon" id="onewayformx">
                  <img
                    src="https://cdn.prod.website-files.com/66fa75fb0d726d65d059a42d/686012f5b7640dd05888924b_x-square.png"
                    alt=""
                  />
                </div>
                <p class="portid onewayformid"></p>
                <p class="airportshort fromshort"></p>
                <p class="airportcity fromcityname"></p>
              </div>
              <div class="search-results"></div>
            </div>
            <div class="eminputblock">
              <label class="bjlabel">Arrival Airport</label>
              <div class="eminput_field">
                <input
                  class="algolio_input onewayto plan_filter_form_input"
                  type="text"
                />
                <div class="cross_input_icon" id="onewaytox">
                  <img
                    src="https://cdn.prod.website-files.com/66fa75fb0d726d65d059a42d/686012f5b7640dd05888924b_x-square.png"
                    alt=""
                  />
                </div>
                <p class="portid onewaytoid"></p>
                <p class="airportshort toshort"></p>
                <p class="airportcity tocityname"></p>
              </div>
              <div class="search-results"></div>
            </div>
            <div class="eminputblock date_block">
              <label class="bjlabel">Departure Date</label>
              <div class="eminput_field">
                <input class="onewaydate plan_filter_form_input" type="date" />
              </div>
            </div>
            <div class="eminputblock">
              <label class="bjlabel pax_label">PAX</label>
              <div class="eminput_field">
                <div class="empax_wrapper">
                  <div class="empax_minus">-</div>
                  <input
                    class="expaxinput plan_filter_form_input onewaypax"
                    type="text"
                    value="1"
                    readonly
                  />
                  <div class="empax_plus">+</div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="algolio_submit">
        <div class="emsubmit">
          <span class="onewaysubmit">Search</span>
        </div>
      </div>
    </div>
    <script>
      // Initialize Algolia search
      const searchClient = algoliasearch(
        "ZSPO7HB4MN",
        "2a3621a18dca4f1fb757e9ddaea72440"
      );
      const index = searchClient.initIndex("Airports");

      function debounce(func, delay) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      }

      function escapeHTML(str) {
        const div = document.createElement("div");
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
      }

      const handleInput = debounce(function (event) {
        const input = event.target;
        if (!input.classList.contains("algolio_input")) return;
        const query = input.value.trim();
        const eminputBlock = input.closest(".eminputblock");
        const resultsContainer = eminputBlock.querySelector(".search-results");
        if (!resultsContainer) {
          console.warn("No .search-results container found for the input.");
          return;
        }

        if (query.length === 0) {
          resultsContainer.innerHTML = "";
          resultsContainer.style.display = "none";
          return;
        }

        // Perform Algolia search
        index
          .search(query)
          .then(({ hits }) => {
            // console.log("Algolia Search Results:", hits);
            if (hits.length > 0) {
              resultsContainer.innerHTML = hits
                .map(
                  (hit) =>
                    `<div class="port" tabindex="0">
              <div class="emfieldnamewrapper">
                <img
                  src="https://cdn.prod.website-files.com/6713759f858863c516dbaa19/6739f54808efbe5ead7a23c1_Screenshot_1-removebg-preview.avif"
                  alt="Location Icon"
                />
                <p class="emfieldname">${escapeHTML(hit["All Fields"])}</p>
                <p class="uniqueid">${escapeHTML(hit["unique id"])}</p>
                <p class="shortcode">${
                  hit["ICAO Code"]
                    ? escapeHTML(hit["ICAO Code"])
                    : hit["IATA Code"]
                    ? escapeHTML(hit["IATA Code"])
                    : hit["FAA Code"]
                    ? escapeHTML(hit["FAA Code"])
                    : ""
                }</p>
                <p class="cityname">${escapeHTML(hit["AirportCity"])}</p>
              </div>
            </div>`
                )
                .join("");
              resultsContainer.style.display = "block";
            } else {
              resultsContainer.innerHTML = "<p>No results found.</p>";
              resultsContainer.style.display = "block";
            }
          })
          .catch((err) => {
            console.error("Algolia search error:", err);
            resultsContainer.innerHTML = "<p>Error fetching results.</p>";
            resultsContainer.style.display = "block";
          });
      }, 300);

      // Function to handle click events on search results
      function handleClick(event) {
        const portElement = event.target.closest(".port");
        if (portElement) {
          const emfieldname =
            portElement.querySelector(".emfieldname").textContent;
          const uniqueid = portElement.querySelector(".uniqueid").textContent;
          const shortcode = portElement.querySelector(".shortcode").textContent;
          const citycode = portElement.querySelector(".cityname").textContent;

          // Find the corresponding input and .portid
          const eminputBlock = portElement.closest(".eminputblock");
          const input = eminputBlock.querySelector(".algolio_input");
          const portidElement = eminputBlock.querySelector(".portid");
          const shortElement = eminputBlock.querySelector(".airportshort");
          const airportCityName = eminputBlock.querySelector(".airportcity");
          input.value = emfieldname;
          portidElement.textContent = uniqueid;
          shortElement.textContent = shortcode;
          airportCityName.textContent = citycode;
          const resultsContainer =
            eminputBlock.querySelector(".search-results");
          resultsContainer.innerHTML = "";
          resultsContainer.style.display = "none";
        }
      }

      // Function to attach event listeners to a given .algolio_wrapper
      function attachListeners(algolioWrapper) {
        algolioWrapper.addEventListener("input", handleInput);
        algolioWrapper.addEventListener("click", handleClick);

        algolioWrapper.addEventListener("focusout", function (event) {
          setTimeout(() => {
            const relatedTarget = event.relatedTarget;

            if (!relatedTarget || !algolioWrapper.contains(relatedTarget)) {
              const allResults =
                algolioWrapper.querySelectorAll(".search-results");
              allResults.forEach((resultsContainer) => {
                resultsContainer.innerHTML = "";
                resultsContainer.style.display = "none";
              });
            }
          }, 100);
        });
      }

      // Select all existing .algolio_wrapper elements and attach listeners
      const algolioWrappers = document.querySelectorAll(".algolio_wrapper");
      algolioWrappers.forEach(attachListeners);

      // Hide search results when clicking outside any .algolio_wrapper
      document.addEventListener("click", function (event) {
        algolioWrappers.forEach((algolioWrapper) => {
          const isClickInside = algolioWrapper.contains(event.target);

          if (!isClickInside) {
            const allResults =
              algolioWrapper.querySelectorAll(".search-results");
            allResults.forEach((resultsContainer) => {
              resultsContainer.innerHTML = "";
              resultsContainer.style.display = "none";
            });
          }
        });
      });
    </script>
  </body>
</html>
